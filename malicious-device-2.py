# Malicious device simulator
# FIDO2
# ECE Capstone 2016/2017
# Reuben Strangelove

import time
import random


import RPi.GPIO as GPIO

GPIO.setmode(GPIO.BCM)
GPIO.setup(14, GPIO.IN, pull_up_down = GPIO.PUD_UP)
GPIO.setup(15, GPIO.IN, pull_up_down = GPIO.PUD_UP)
GPIO.setup(2, GPIO.OUT)
GPIO.setup(3, GPIO.OUT)

import can

bus0 = can.interface.Bus(channel='can0', bustype='socketcan_native')

acceptable_packets = [[0x01, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x01, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x02, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x02, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x03, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x03, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x04, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x04, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x05, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x05, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x06, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x06, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x07, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x07, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x08, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x08, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x09, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x09, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x0A, 0x12, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x0A, 0x19, 0x30, 0x40, 0x50, 0x60, 0x07]]

malicious_packets = [[0x41, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x41, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x42, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x42, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x43, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x43, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x44, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x44, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x45, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x45, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x46, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x46, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x47, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x47, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x48, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x48, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x49, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x49, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x4A, 0x90, 0x30, 0x40, 0x50, 0x60, 0x07],
[0x4A, 0xF3, 0x30, 0x40, 0x50, 0x60, 0x07]]


try:

	while 1:

		if GPIO.input(14):

			GPIO.output(3, GPIO.HIGH)

			id = random.randint(0,100)
			packet = random.randint(0,19)
			msg = can.Message(arbitration_id = id, data = acceptable_packets[packet], extended_id = False)
			bus0.send(msg)
			print("Acceptable packet sent with id: ", msg.arbitration_id)

		else:

			GPIO.output(3, GPIO.LOW)



		if GPIO.input(15):

			GPIO.output(2, GPIO.HIGH)

			id = random.randint(0,100)
			packet = random.randint(0,19)
			msg = can.Message(arbitration_id = id, data = malicious_packets[packet], extended_id = False)
			bus0.send(msg)
			print("Malicious packet sent with id: ", msg.arbitration_id)

		else:

			GPIO.output(2, GPIO.LOW)

		time.sleep(0.100)

except KeyboardInterrupt:

	GPIO.cleanup()

